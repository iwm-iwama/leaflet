<!-- iwm0200121B Ver.20200321_1256 'U-2S' -->

<!DOCTYPE html>
<html lang="ja">

<head>
<meta charset="UTF-8"/>
<meta http-equiv="Content-Script-Type" content="text/javascript">
<title>地理院タイル・簡易ビュアー</title>

<!-- ライブラリ開発諸氏に敬意を表す -->

<!--------------------------------------------------------------------
// leaflet
--------------------------------------------------------------------->
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js" integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew==" crossorigin=""></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>

<!--------------------------------------------------------------------
// Control.MiniMap
--------------------------------------------------------------------->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-minimap/3.6.1/Control.MiniMap.css"/>

<!--------------------------------------------------------------------
// leaflet.awesome-markers.min
--------------------------------------------------------------------->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>

<!--------------------------------------------------------------------
// font-awesome
--------------------------------------------------------------------->
<link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.css"/>

<!--------------------------------------------------------------------
// Leaflet.PolylineMeasure
--------------------------------------------------------------------->
<script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>
<link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css"/>

<!--------------------------------------------------------------------
// Leaflet.greatCircle
--------------------------------------------------------------------->
<script src="https://nuclearsecrecy.github.io/Leaflet.greatCircle/Leaflet.greatCircle.js"></script>

<!--------------------------------------------------------------------
// Leaflet.Graticule
--------------------------------------------------------------------->
<script type="text/javascript" src="https://leaflet.github.io/Leaflet.Graticule/Leaflet.Graticule.js"></script>

<!--------------------------------------------------------------------
// CSS
--------------------------------------------------------------------->
<style>
@charset "utf-8";

/*-------
// 共通
-------*/
*
{
	font-family:sans-serif;
	margin:0;
	padding:0;
}
/*------------------
// leaflet CSS置換
------------------*/
.leaflet-popup-content-wrapper,
.leaflet-popup-tip
{
	background:#fff;
	border-color:#333;
	-webkit-border-radius:3px !important;
	-moz-border-radius:3px !important;
	border-radius:3px !important;
}
.leaflet-popup-content,
.leaflet-popup-close-button
{
	color:#333 !important;
	font:11px Sans-serif;
	line-height:14px;
	margin:0;
	padding:2px 5px;
}
.leaflet-container
{
	background:#fff;
}
#map
{
	position:absolute;
	top:0;
	left:0;
	width:100%;
	height:100%;
	margin:0;
	padding:0;
}
/*-------------------
// 本スクリプト関係
-------------------*/
body
{
	background:#f6f6f7;
	margin:0;
	padding:0;
}
select
{
	background:#fff;
	border:0;
	cursor:pointer;
	font-size:11px;
	height:19px;
	margin:0 0 0 8px;
	padding:0;
	width:80px;
}
select:hover
{
	background:#ff5 !important;
}
option
{
	background:#fff;
	font-size:14px;
	margin:0 0 0 4px;
	padding:4px;
}
._btnNavi1,
._btnNavi2,
._btnNavi3,
._btnNavi4
{
	border:0;
	color:#fff;
	font-size:12px;
	margin:0;
	padding:0 8px;
	text-decoration:none;
}
._btnNavi1:hover,
._btnNavi2:hover,
._btnNavi3:hover,
._btnNavi4:hover
{
	cursor:pointer;
}
._btnNavi1
{
	background:#3d7cce;
}
._btnNavi1:hover
{
	background:#6dacff !important;
}
._btnNavi2
{
	background:#bd1e38;
}
._btnNavi2:hover
{
	background:#ed4e68 !important;
}
._btnNavi3
{
	background:#2dae6c;
}
._btnNavi3:hover
{
	background:#3dce7c !important;
}
._btnNavi4
{
	background:#855896;
}
._btnNavi4:hover
{
	background:#955aa6 !important;
}
/*---------------
// 上部メニュー
---------------*/
#_divNaviCommander
{
	background:#505050;
	border:0;
	border-radius:8px 8px 0 0;
	color:#fff;
	font-size:14px;
	line-height:18px;
	left:0;
	margin:0;
	padding:2px 4px 2px 10px;
	position:absolute;
	top:0;
	/* 動的に変更 */
	width:0;
}
#_divMap
{
	cursor:crosshair;
	left:0;
	position:absolute;
	top:24px;
	/* 動的に変更 */
	height:0;
	width:0;
}
#_InputBL,
#_InputZoomA,
#_InputZoomB
{
	background-color:rgba(255, 255, 255, 0.6);
	border:1px solid #777;
	font-size:12px;
	margin:0;
	padding:2px;
	position:absolute;
	z-index:2000;
}
#_InputBL,
#_InputZoomA
{
	top:-1000px;/* フォーマット時に隠すため */
}
#_InputZoomB
{
	/* 以下、必要に応じて修正 */
	left:12px;
	top:37px;
}
/* ↓OverLap */
#_InputBL
{
	text-align:left;
	width:120px;
}
#_InputZoomA
{
	text-align:center;
	width:150px;
}
#_InputZoomB
{
	border:0;
	margin:0;
	padding:0;
	text-align:center;
}
/* ↑OverLap */
._Btn1,
._Btn2,
._Btn3,
._ZA,
._ZB
{
	border:0;
	color:#fff;
	cursor:pointer;
	font-size:12px;
	line-height:0;
	margin:2px;
	padding:0;
}
/* ↓OverLap */
._Btn1,
._ZA,
._ZB
{
	background-color:rgba(0, 0, 0, 0.6);
}
._Btn1:hover,
._ZA:hover,
._ZB:hover
{
	background:#3c7bff !important;
}
._Btn2
{
	background-color:rgba(12, 75, 157, 0.8);
}
._Btn2:hover
{
	background:#3c7bff !important;
}
._Btn3
{
	background-color:rgba(229, 72, 72, 0.9);
}
._Btn3:hover
{
	background:#ff5858 !important;
}
#_InputBL > ._Btn1,
#_InputBL > ._Btn2,
#_InputBL > ._Btn3
{
	height:23px;
	width:36px;
}
._ZB
{
	margin:0;
}
#_InputZoomA > ._ZA,
#_InputZoomA > ._Btn3,
#_InputZoomB > ._ZB
{
	height:26px;
	width:26px;
}
#_IBL1,
#_IBL2,
#_IBL3
{
	background:#fff;
	border:1px solid #000;
	color:#000;
	cursor:text;
	height:16px;
	ime-mode:inactive;
	margin:1px 2px;
	padding:0 2px;
	text-align:left;
}
#_IBL1:hover,
#_IBL2:hover,
#_IBL3:hover,
#_IBL1:focus,
#_IBL2:focus,
#_IBL3:focus
{
	background:#ff5 !important;
}
/* ↑OverLap */
#_NaviZoom,
#_NaviLat,
#_NaviLng
{
	border:0;
	font-size:12px;
	ime-mode:inactive;
	margin:0;
	padding:0 3px;
}
#_NaviLat,
#_NaviLng
{
	width:100px;
}
#_NaviZoom:hover,
#_NaviLat:hover,
#_NaviLng:hover,
#_NaviZoom:focus,
#_NaviLat:focus,
#_NaviLng:focus
{
	background:#ff5 !important;
}
/*---------------------
// アドレスマッチング
---------------------*/
#_AddMatchInput
{
	background:orange;
	border:0;
	line-height:14px;
	margin:0;
	padding:0;
	position:absolute;
	z-index:600;
	/* 以下、必要に応じて修正 */
	left:52px;
	top:37px;
}
#_AddMatchInput1
{
	background:#fff;
	border:1px solid orange;
	color:#000;
	cursor:text;
	font-size:14px;
	height:18px;
	ime-mode:inactive;
	margin:0;
	padding:0 3px;
	width:100px;
}
#_AddMatchInput1:hover
{
	background:#ff5 !important;
}
#_AddMatchInput2
{
	border:0;
	color:#fff;
	font-size:14px;
	font-weight:500;
	margin:0;
	padding:0 3px;
}
#_AddMatchInput3
{
	border:0;
	color:#fff;
	font-size:16px;
	font-weight:900;
	margin:0;
	padding:0 2px 0 0;
}
#_AddMatchInput2:hover,
#_AddMatchInput3:hover
{
	color:#f00;
	cursor:pointer;
}
#_AddMatchOutput
{
	background-color:rgba(255, 255, 255, 0.2);
	border:1px solid orange;
	color:#000;
	font-size:13px;
	left:0;
	margin:2px 0 0 2px;
	overflow:auto;
	position:absolute;
	top:-1000px;/* フォーマット時に隠すため */
	z-index:600;
	/* 以下、必要に応じて修正 */
	max-height:480px;
	padding:6px;
	width:220px;
}
#_AddMatchOutput:hover
{
	background:#fff !important;
}
#_AddMatchOutputH
{
	color:#00d;
	padding:0 0 4px 0;
}
#_AddMatchOutputF
{
	padding:4px 0 0 0;
	text-align:center;
}
#_AddMatchOutput1
{
	color:#000;
	font-size:14px;
	line-height:14px;
	margin:0;
	padding:6px 4px;
}
#_AddMatchOutput1:hover
{
	background:#ff5 !important;
}
._AddMatchRem
{
	color:#f00;
	font-size:11px;
}
/*---------
// 距離円
---------*/
#_GCircle
{
	background-color:rgba(0, 0, 0, 0.3);
	color:#fff;
	font-size:8pt;
	height:26px;
	padding:0 0 0 8px;
	position:absolute;
	text-align:left;
	width:220px;
	z-index:500;
}
/*----------------
// Simple Window
----------------*/
._simpleWindowCall
{
	border:solid 1px #fff;
	color:#fff;
	font-size:13px;
	font-weight:500;
	float:right;
	margin:0;
	padding:0 4px;
}
._simpleWindowCall:hover
{
	color:#f00;
	cursor:pointer;
}
._simpleWindow
{
	background-color:rgba(13, 76, 158, 0.8);
	color:#fff;
	float:right;
	font-size:11px;
	line-height:18px;
	margin:0;
	padding:0;
	position:absolute;
	text-align:center;
	z-index:2000;
	/* 以下、必要に応じて修正 */
	right:0;
	top:24px;
}
._simpleWindowTitle
{
	display:;/* 不使用のとき"none"を代入 */
	margin:0;
	padding:0;
}
._simpleWindowClose
{
	color:#f00;
	float:right;
	font-size:18px;
	font-weight:900;
	padding:0 3px 0 0;
}
._simpleWindowClose:hover
{
	color:#fff;
	cursor:pointer;
}
._simpleWindowOutput
{
	background:#fff;
	border:0;
	color:#000;
	font-size:13px;
	line-height:14px;
	margin:1px;
	overflow:auto;
	padding:16px 0;
	text-align:left;
}
/*---------------
// Edit Textbox
---------------*/
._editTextBox
{
	border:2px solid #fa0;
	color:#000;
	font-size:13px;
	ime-mode:inactive;
	margin:0;
	overflow:auto;
	padding:2px 6px;
	resize: none;
}
._editTextBox:focus,
._editTextBox:hover
{
	background:#ffa;
}
/*-----------
// 距離測定
-----------*/
.leaflet-control
{
	cursor:pointer;
}
a.polyline-measure-controlOnBgColor,
a.polyline-measure-controlOnBgColor:hover
{
	background-color:#5f5;
}
.polyline-measure-unicode-icon
{
	font-size:19px;
	font-weight:bold;
}
a.polyline-measure-clearControl:active {
	background-color:#f00;
}
.polyline-measure-tooltip
{
	background-color:rgba(0, 0, 0, 0.7);
	border-radius:3px;
	box-shadow:none;
	font-style:normal;
	height:auto !important;
	margin:0;
	padding:1px 4px 2px 4px;
	text-align:right;
	white-space:nowrap;
	width:auto !important;
}
.polyline-measure-tooltip-end
{
	background-color:rgba(0, 0, 0, 0.7);
}
.polyline-measure-tooltip-difference
{
	color:#f00;
	font:11px sans-serif;
	font-style:normal;
	font-weight:bold;
	line-height:12px;
}
.polyline-measure-tooltip-total
{
	color:#fff;
	font:13px sans-serif;
	font-style:normal;
	font-weight:normal;
	line-height:12px;
}
.polyline-measure-popupTooltip
{
	color:#f00;
	font:12px sans-serif;
	font-weight:bold;
	line-height:14px;
	margin:0;
	padding:4px;
}
</style>

<script>
	// muni.js を使うためのおまじない
	var GSI = {ClientMode:{}, Modal:{}, Draw:{}, Edit:{}, Control:{}, Utils:{Browser:{}}, GLOBALS:{}, TEXT:{}};
</script>
<script type="text/javascript" src="https://maps.gsi.go.jp/js/muni.js"></script>
<script>
/*-----------------------
// フレームサイズを調整
-----------------------*/
function subInitDisp(){
	var mapH = window.innerHeight;
	var mapW = window.innerWidth;

	// Microsoft?
	var uA = window.navigator.userAgent.toLowerCase();
	/// console.log(uA);

	if(uA.indexOf("edge") > -1 || uA.indexOf("trident") > -1 || uA.indexOf("msie") > -1){
		alert("このブラウザでは正しく表示されません\n\n【動作確認済】\n・Firefox\n・Google Chrome\n・Opera\n・Vivaldi");
		exit;
	}

	// _divNaviCommander
	document.getElementById("_divNaviCommander").style.width = (mapW - 14) + "px";

	// _divMap
	with(document.getElementById("_divMap").style){
		height = (mapH - 24) + "px";
		width  = mapW + "px";
	}
}

/*--------------------
// URL／BL表示を変更
--------------------*/
function subChangeUrl(
	$Lat,
	$Lng,
	$Zoom
){
	for(var _i1 = 0, _i2 = arguments.length; _i1 < _i2; _i1++){
		if(isNaN(arguments[_i1])){
			arguments[_i1] = document.getElementById(arguments[_i1]).value;
		}
	}
	with(document){
		getElementById("_NaviLat").value  = parseFloat($Lat).toFixed(8);
		getElementById("_NaviLng").value  = parseFloat($Lng).toFixed(8);
		getElementById("_NaviZoom").value = $Zoom;
	}
	// URL置換
	history.replaceState(
		null,
		null,
		("#" + $Zoom + "/" + $Lat + "/" + $Lng)
	);
}

/*------------------------------------
// (例) (255, 255, 255) => "#ffffff"
------------------------------------*/
/*
function rtnRgbTo16(
	$r,
	$g,
	$b
){
	var rtn = "#";
	for(var _i1 = 0; _i1 < 3; _i1++){
		var _i2 = parseInt(arguments[_i1], 10);
		if(_i2 < 0){
			_i2 = 0;
		}
		else if(_i2 > 255){
			_i2 = 255;
		}
		rtn += ("0" + _i2.toString(16)).slice(-2);
	}
	return rtn;
}
*/

/*---------------
// 数値入力補完
---------------*/
// 大域変数
var $subIwmInput_BL_now = null;
var $subIwmInput_BL_toSave = null;

// 環境に合わせて設定
const $subIwmInput_array = ["_InputBL"];

function subIwmInput_Init(){
	for(var _s1 of $subIwmInput_array){
		subIwmInput_Close(_s1);
	}
}
function subIwmInput_ZoomA_Open(
	$outputId, // [id]
	$posX,     // INT
	$posY      // INT
){
	subIwmInput_Open("_InputZoomA", $outputId, $posX, $posY, true);
}
function subIwmInput_ZoomA_Close(){
	subIwmInput_Close("_InputZoomA");
}
function subIwmInput_Zoom_Change(
	$str
){
	document.getElementById("_NaviZoom").value = parseInt($str, 10);

	var Color1 = "#000";
	var Color2 = "#0c4b9d";

	var obj1 = document.getElementsByClassName("_ZA");
	var obj2 = document.getElementsByClassName("_ZB");

	var i1 = $str;
	var i2 = 0;
	var i3 = obj1.length;
	for(; i2 < i3; i2++){
		obj1[i2].style.background = (i1 == obj1[i2].value ? Color2 : Color1);

		if(i1 == obj1[i2].value){
			obj1[i2].style.background = Color2;
			obj1[i2].style.opacity = 0.8;
		}
		else{
			obj1[i2].style.background = Color1;
			obj1[i2].style.opacity = 0.6;
		}

		if(i1 == obj2[i2].value){
			obj2[i2].style.background = Color2;
			obj2[i2].style.opacity = 0.8;
		}
		else{
			obj2[i2].style.background = Color1;
			obj2[i2].style.opacity = 0.6;
		}
	}

	subIwmInput_Close("_InputZoomA");
}
function subIwmInput_BL_Open(
	$outputId // [id]
){
	if(!document.getElementById($outputId).value.length){
		return;
	}
	var iId = "_InputBL";
	$subIwmInput_BL_toSave = $outputId;
	// "_InputBL" を更新
	_iwmIBL($outputId);
	subIwmInput_Open(iId, $outputId, null, null, false);
}
function subIwmInput_BL_Close(){
	document.getElementById($subIwmInput_BL_toSave).value = rtnGeoIBLto10A(
		document.getElementById("_IBL1").value,
		document.getElementById("_IBL2").value,
		document.getElementById("_IBL3").value
	);
	subIwmInput_Close("_InputBL");
}
function subIwmInput_BL_GetId(
	$outputId // [id]
){
	$subIwmInput_BL_now = $outputId;
}
function subIwmInput_BL_Keydown(
	$outputId,   // [id]
	$decimalSize // 小数点桁数
){
	if($decimalSize == undefined){
		$decimalSize = 0;
	}

	// 他のコントロールに影響するので、
	// 都度、document.onkeydown = function(evt){} で初期化すること。
	document.onkeydown = function(evt){
		/// console.log(evt.keyCode);
		switch(evt.keyCode){
			case(13): // [Enter]
				var obj = document.getElementById($outputId);
				var d1 = parseFloat(obj.value).toFixed($decimalSize);

				if(isNaN(d1)){
					return;
				}
				obj.value = d1;

				if($subIwmInput_BL_now == null){
					_iwmIBL(d1);
				}
				else{
					document.getElementById($subIwmInput_BL_toSave).value = rtnGeoIBLto10A(
						document.getElementById("_IBL1").value,
						document.getElementById("_IBL2").value,
						document.getElementById("_IBL3").value
					);
				}
				// ベースマーカー再描画
				_iwmBMN();
				// URL／BL表示を変更
				_iwmCU();
				// センタリング
				_iwmCM();
				// 距離円再描画
				subGCircle_Init();
			break;
		}
	}
}
function subIwmInput_Open(
	$inputId,   // [id]
	$outputId,  // [id]
	$posX,      // iNT
	$posY,      // INT
	$autoHidden // BOOL
){
	$subIwmInput_BL_now = $outputId;

	// 他の入力フォームを全て閉じる
	subIwmInput_Init();

	var obj = document.getElementById($outputId);
	var rect = obj.getBoundingClientRect();

	var posX = ($posX == undefined || $posX == null ? rect.left + window.pageXOffset : $posX);
	var posY = ($posY == undefined || $posY == null ? rect.top + window.pageYOffset + obj.clientHeight : $posY);

	with(document.getElementById($inputId).style){
		display = "";
		top  = posY + "px";
		left = posX + "px";
	}

	// 設定ミリ秒後に自動終了
	if($autoHidden){
		setTimeout("subIwmInput_Close('" + $inputId + "')", 2500);
	}
}
function subIwmInput_Close(
	$outputId // [id]
){
	try{
		document.getElementById($outputId).style.display = "none";
	}
	catch(e){
		/// console.log(e);
	}
	// 初期化
	$subIwmInput_BL_now = null;
	document.onkeydown = function(evt){}
}
$subIwmInput_strPos = 0;
function subIwmInput_AddText(
	$str
){
	var obj = document.getElementById($subIwmInput_BL_now);
	var strBefore = obj.value;
	var strBeforeLen = strBefore.length;
	$subIwmInput_strPos = obj.selectionStart;
	obj.value = strBefore.substr(0, $subIwmInput_strPos) + $str + strBefore.substr($subIwmInput_strPos, strBeforeLen);
	$subIwmInput_strPos++;
	// 再フォーカス
	document.getElementById($subIwmInput_BL_now).focus();
	obj.selectionStart = $subIwmInput_strPos;
}
function subIwmInput_Cls(){
	document.getElementById($subIwmInput_BL_now).value = "";
	// 再フォーカス
	document.getElementById($subIwmInput_BL_now).focus();
	$subIwmInput_strPos = 0;
}
function subIwmInput_Bs(){
	var obj = document.getElementById($subIwmInput_BL_now);
	var strBefore = obj.value;
	var strBeforeLen = strBefore.length;
	$subIwmInput_strPos = obj.selectionStart;
	$subIwmInput_strPos--;
	if($subIwmInput_strPos < 0){
		$subIwmInput_strPos = 0;
	}
	obj.value = strBefore.substr(0, $subIwmInput_strPos) + strBefore.substr(($subIwmInput_strPos + 1), strBeforeLen);
	// 再フォーカス
	document.getElementById($subIwmInput_BL_now).focus();
	obj.selectionStart = $subIwmInput_strPos;
}
function subIwmInput_Del(){
	var obj = document.getElementById($subIwmInput_BL_now);
	var strBefore = obj.value;
	var strBeforeLen = strBefore.length;
	$subIwmInput_strPos = obj.selectionStart;
	if($subIwmInput_strPos > strBeforeLen){
		$subIwmInput_strPos = strBeforeLen;
	}
	obj.value = strBefore.substr(0, $subIwmInput_strPos) + strBefore.substr(($subIwmInput_strPos + 1), strBeforeLen);
	// 再フォーカス
	document.getElementById($subIwmInput_BL_now).focus();
	obj.selectionStart = $subIwmInput_strPos;
}
/*-------------
// エイリアス
-------------*/
// "_InputBL" を更新
function _iwmIBL(
	$d1 // DBL
){
	if(isNaN($d1)){
		$d1 = document.getElementById($d1).value;
	}
	var [deg, min, sec] = rtnGeo10toIBL($d1);
		document.getElementById("_IBL1").value = deg.toFixed(0);
		document.getElementById("_IBL2").value = min.toFixed(0);
		document.getElementById("_IBL3").value = sec.toFixed(8);
}
// ベースマーカー再描画
function _iwmBMN(){
	subBaseMarkerNew("_NaviLat", "_NaviLng");
}
// URL／BL表示を変更
function _iwmCU(){
	subChangeUrl("_NaviLat", "_NaviLng", "_NaviZoom");
}
// センタリング
var _iwmCM_hash = null;
function _iwmCM(){
	if(_iwmCM_hash){
		subCenterMap1(_iwmCM_hash.lat, _iwmCM_hash.lng);
		_iwmCM_hash = null;
	}
	else{
		subCenterMap1(
			document.getElementById("_NaviLat").value,
			document.getElementById("_NaviLng").value,
		);
	}
}
function _iwmZA(
	$str
){
	subIwmInput_ZoomA_Close();
	subIwmInput_Zoom_Change($str);
	// ベースマーカー再描画
	_iwmBMN();
	// URL／BL表示を変更
	_iwmCU();
	// センタリング
	_iwmCM();
	// 距離円再描画
	subGCircle_Init();
}
function _iwmZA2(){
	subIwmInput_ZoomA_Close();
	// センタリング
	_iwmCM();
	// 距離円再描画
	subGCircle_Init();
}
function _iwmZB(
	$str
){
	subIwmInput_Zoom_Change($str);
	// URL／BL表示を変更
	_iwmCU();
	// センタリング
	_iwmCM();
	// 距離円再描画
	subGCircle_Init();
}
function _iwmBL(){
	for(var _s1 of ["_IBL1", "_IBL2", "_IBL3"]){
		if(!document.getElementById(_s1).value.length){
			return;
		}
	}
	subIwmInput_BL_Close();
	// URL／BL表示を変更
	_iwmCU();
	// ベースマーカー再描画
	_iwmBMN();
	// センタリング
	_iwmCM();
	// 距離円再描画
	subGCircle_Init();
}
/*---------------------
// アドレスマッチング
---------------------*/
var $subAddMatch_cnt = 0;
var $AddMatchMarker = null;
const $HashAddMatchOutputZoom = {exist: "↑", none: "↓"};

// 初期化
function subAddMatch_Init(){
	// 初期化
	$subAddMatch_cnt = 0;

	// Input
	with(document.getElementById("_AddMatchInput1")){
		value = "";
		focus();
	}
	// Zoom
	document.getElementById("_AddMatchInput2").style.display = "none";

	// Reset
	document.getElementById("_AddMatchInput3").style.display = "none";

	// Output
	with(document.getElementById("_AddMatchOutput")){
		style.display = "none";

		var obj = document.getElementById("_AddMatchInput1");
		var rect = obj.getBoundingClientRect();
			style.left = (rect.left + window.pageXOffset - 2) + "px";
			style.top  = (rect.top + window.pageYOffset + obj.clientHeight - 1) + "px";

		innerHTML = "";
	}
}
function subAddMatch_1(){
	var query = document.getElementById("_AddMatchInput1").value;

	if(!query.trim().length){
		subAddMatch_Init();
		return;
	}
	const _Url = "https://msearch.gsi.go.jp/address-search/AddressSearch?q=" + query;

	var xhr = new XMLHttpRequest();
	xhr.onload = function(){
		var aJson = JSON.parse(xhr.responseText);
		$subAddMatch_cnt = aJson.length;

		// 再検索時に結果を表示させるため
		document.getElementById("_AddMatchInput2").innerHTML = $HashAddMatchOutputZoom.none;

		var flg = subAddMatch_2();
		if(flg){
			with(document.getElementById("_AddMatchOutput")){
				var rtn = "<div id='_AddMatchOutputH'>◆ヒット数 " + $subAddMatch_cnt + " 件</div>";
				for(var _s1 of aJson){
					with(_s1){
						var _s2 = "";
						// データ不完全のため例外処理が必要
						try{
							var addCode = parseInt(properties.addressCode, 10) + "";
							var a1 = GSI.MUNI_ARRAY[addCode].split(",");
							_s2 = a1[1] + " " + a1[3].replace("　", " ");
						}
						catch(e){
							/// console.log(e + "\n" + _i1 + " | " + properties.addressCode + " | " + properties.title + " | " + geometry.coordinates);
						}
						var [lng, lat] = geometry.coordinates;

						rtn += "<div id=\"_AddMatchOutput1\" onmouseover=\"subAddMatch_Spot([" + lat + "," + lng + "],'" + properties.title + "');\" onmouseout=\"subAddMatch_SpotClear();\" onclick=\"subMapOnRClick('" + lat + "','" + lng + "','" + properties.title + "');\">" +
							"<div class='_AddMatchRem'>" + _s2 + "</div>" +
							properties.title + "</div>";
					}
				}
				// 著作権表示
				rtn += "<div id='_AddMatchOutputF'>【<a href='http://newspat.csis.u-tokyo.ac.jp/geocode/' target='_blank'>協力:東大CSIS</a>】</div>";
				innerHTML = rtn;
			}
		}
	}
	xhr.open("GET", _Url, true);
	/// xhr.overrideMimeType("text/javascript");
	xhr.send(null);
}
function subAddMatch_2(){
	var rtn = true;

	var oInput2 = document.getElementById("_AddMatchInput2");
	var oInput3 = document.getElementById("_AddMatchInput3");
	var oOutput = document.getElementById("_AddMatchOutput");

	if($subAddMatch_cnt > 1000){
		oInput2.style.display = "none";
		oInput3.style.display = "";
		with(oOutput){
			style.display = "";
			style.height = "auto";
			innerHTML = "★ヒット数が1000件超あります!!<br>　条件を増やしてみてください。";
		}
		rtn = false;
	}
	else if($subAddMatch_cnt > 0){
		oInput2.style.display = "";
		oInput3.style.display = "";
		oOutput.style.display = "";

		if(oInput2.innerHTML == $HashAddMatchOutputZoom.exist){
			oInput2.innerHTML = $HashAddMatchOutputZoom.none;
			oOutput.style.display = "none";
		}
		else{
			oInput2.innerHTML = $HashAddMatchOutputZoom.exist;
			oOutput.style.display = "";
			rtn = true;
		}
	}
	else{
		oInput2.style.display = "none";
		oInput3.style.display = "";
		with(oOutput){
			style.display = "";
			style.height = "auto";
			innerHTML = "★ヒット数が0件です。<br>　条件を変えてみてください。";
		}
		rtn = false;
	}

	return rtn;
}
function subAddMatch_Spot(
	$aLatLng,
	$title
){
	$AddMatchMarker = (
		L.circleMarker(
			$aLatLng,
			{
				radius: 8,
				color: "#ff5",
				weight: 8,
				fill: true,
				fillColor: "#f00",
				fillOpacity: 0.8,
				title: $title
			}
		).addTo($Map).bindPopup(
			$title,
			{
				autoPan: false,
				closeButton: false
			}
		).openPopup()
	);
}
function subAddMatch_SpotClear(){
	if($AddMatchMarker){
		$AddMatchMarker.remove($Map);
		$AddMatchMarker = null;
	}
}
/*-------------------------------
// 緯度経度⇒アドレスマッチング
-------------------------------*/
function subLatLngToPlaceName(
	$lat,
	$lng,
	$oMarker,
	$placeName
){
	const _Url = "https://mreversegeocoder.gsi.go.jp/reverse-geocoder/LonLatToAddress?lat=" + $lat + "&lon=" + $lng;

	var xhr = new XMLHttpRequest();
	xhr.onload = function(){
		var title = null;
		var obj = JSON.parse(xhr.responseText);
		if(obj.results == undefined){
			title = "---";
		}
		else{
			var muniCd = parseInt(obj.results.muniCd, 10);
			var lv01Nm = obj.results.lv01Nm;
			var a1 = GSI.MUNI_ARRAY[muniCd].split(",");
			title = (a1[1] + a1[3] + lv01Nm).replace(/　/g, "");
		}
		// 地名付与 ⇒ 自由／固定区別
		if($oMarker.options.draggable){
			$oMarker.options.title = title;
		}
		else{
			// 固定点地名 ⇒ 初回に付与してあればパス
			if(!$oMarker.options.title){
				$oMarker.options.title = $placeName + "<br>＠" + title;
			}
		}
	};
	xhr.open("GET", _Url, true);
	/// xhr.overrideMimeType("text/javascript");
	xhr.send(null);
}
/*----------------
// Simple Window
----------------*/
// 初期化
function subSimpleWindow_Init(
	$aryId
){
	var i1 = $aryId.length;
	while(i1--){
		document.getElementById($aryId[i1]).style.display = "none";
	}
}
function subSimpleWindow_OnOff(
	$id,
	$func
){
	// Open／Close
	var obj = document.getElementById($id);
	if(!obj.style.display.length){
		obj.style.display = "none";
	}
	else{
		obj.style.display = "";
		eval($func);
	}
}
function subSimpleWindow_HDoc01(
	$id
){
	document.getElementById($id).innerHTML = document.getElementById("_HDoc01").value;
}
/*---------------
// Edit Textbox
---------------*/
/*---------------
// 地図から読込
---------------*/
function subMapToPoint(
	$textareaId
){
	var str = "";

	// 表示更新されてないと読込エラーになるので意図的にポップアップ
	subMarkerPopup($BaseMarker, $AryLocalMarker);

	for(var _o1 of $AryLocalMarker.concat($AryPoint)){
		var _s1 = _o1._popup._content;

		if(_s1.match(/\.\d{4}度$/)){
			_s1 = _s1.substring(0, _s1.lastIndexOf("<br/>"));
		}

		// TSVファイルの "\t" は "<br/>"
		// 通常の改行は "<br>"
		_s1 = _s1.replace(/<br\/>/g, "\t");

		str += _o1._latlng.lat.toFixed(8) + "\t" + _o1._latlng.lng.toFixed(8) + "\t" + _s1 + "\n";
	}
	// 上書き
	document.getElementById($textareaId).value = str;
}
/*----------------------
// ファイル読込（追加）
----------------------*/
var $FileName = "";

function subAddReadFile(
	$fileId,
	$textareaId
){
	// ボタンにイベントを設定
	var fileList = document.getElementById($fileId).files;

	// ファイル名記憶
	$FileName = fileList[0].name;

	var reader = new FileReader();
	reader.onload = function(evt){
		// 追加保存
		document.getElementById($textareaId).value += evt.target.result;
	}
	// テキスト書込
	reader.readAsText(fileList[0]);
}
/*---------------
// 住所から変換
---------------*/
function subA2P_Geocoding(
	$textareaId
){
	const _Url = "https://msearch.gsi.go.jp/address-search/AddressSearch?q=";

	var xhr = new XMLHttpRequest();

	var str = "";
	var errCnt = 0;

	for(var _s1 of document.getElementById($textareaId).value.trimEnd().replace(/\\t/g, "\t").split("\n")){
		_s1 = _s1.trim();
		var _a1 = _s1.split("\t");
		var query = _a1[0];
		if(query){
			/// console.log(query);
			if(query.match(/^\d+\.\d+/) || query.substr(0, 2) == "//"){
				str += _s1;
			}
			else{
				var url = _Url + query;

				xhr.open("GET", url, false);
				/// xhr.overrideMimeType("text/javascript");
				xhr.send(null);

				var aJson = JSON.parse(xhr.responseText);

				if(aJson.length == 1){
					var [lng, lat] = aJson[0].geometry.coordinates;
					str += lat.toFixed(8) + "\t" + lng.toFixed(8) + "\t" + _s1;
				}
				else{
					str += "// Err " + (aJson.length == 0 ? "該当なし" : "複数該当あり") + " => " + _s1;
					errCnt++;
				}
			}
			str += "\n";
		}
	}

	if(str){
		document.getElementById($textareaId).value = str;
	}

	with(document.getElementById($textareaId).style){
		if(errCnt){
			color = "#fff";
			backgroundColor = "#f00";
		}
		else{
			color = "#000";
			backgroundColor = "#fff";
		}
	}
}
/*---------------
// サンプル出力
---------------*/
function subA2P_GeocodingSample(
	$textareaId
){
	document.getElementById($textareaId).value = "千代田区千代田1-1\t皇居\nつくば市北郷1\t国土地理院\n";
}
/*-------------------------
// クリップボードにコピー
-------------------------*/
function subA2P_EditCopy(
	$id
){
	document.getElementById($id).select();
	document.execCommand("copy");
}
/*-------------
// 地図へ反映
-------------*/
var $AryPoint = [];

function subA2P_PointToMap(
	$textareaId
){
	var i1 = $AryPoint.length;
	while(i1--){
		// マーカー消去
		$AryPoint[i1].remove($Map);
		// 配列から削除
		$AryPoint.splice(i1, 1);
	}

	var str ="";

	for(var _s1 of document.getElementById($textareaId).value.trimEnd().split("\n")){
		_s1 = _s1.trim();

		// TSVファイルの "\t" は "<br/>"
		// 通常の改行は "<br>"
		_s1 = _s1.replace(/\\t/g, "\t");
		_s1 = _s1.replace(/\\n/g, "<br>");

		var _a1 = _s1.split("\t");

		if(_a1.length >= 2){
			try{
				if(_a1.length >= 3){
					_s2 = _a1[2];
					for(var _i1 = 3, _i2 = _a1.length; _i1 < _i2; _i1++){
						_s2 += "<br/>" + _a1[_i1];
					}
				}
				else{
					_s2 = "<br/>";
				}

				var obj1 = (
					L.circleMarker(
						[_a1[0], _a1[1]],
						{
							radius: 8,
							color: "#5ff",
							weight: 8,
							fill: true,
							fillColor: "#00f",
							fillOpacity: 0.8,
							title: _a1[2]
						}
					).addTo($Map)
				);

				var obj2 = obj1.bindPopup(
					_s2,
					{
						autoPan: false,
						closeButton: true
					}
				).openPopup();

				$AryPoint.push(obj2);
			}
			catch(e){
			}

			str += _s1 + "\n";
		}
	}

	if(str){
		document.getElementById($textareaId).value = str;
	}
}
/*-----------------
// ファイルに保存
-----------------*/
function subA2P_EditSave(
	$textareaId,
	$hrefId
){
	var content = document.getElementById($textareaId).value;
	var blob = new Blob([content], {"type" : "text/plain"});
	var fn = ($FileName ? $FileName : "マーカー変換.tsv");

	// MSIE?
	if(window.navigator.msSaveBlob){
		window.navigator.msSaveBlob(blob, fn);
		window.navigator.msSaveOrOpenBlob(blob, fn);
	}
	else{
		document.getElementById($hrefId).download = fn;
		document.getElementById($hrefId).href = window.URL.createObjectURL(blob);
	}
}
/*---------
// クリア
---------*/
function subA2P_EditClear(
	$textareaId,
	$selectId
){
	/// document.getElementById($textareaId).value = "";
	document.getElementById($selectId).value = 0;

	subA2P_GCircle($selectId, $textareaId);

	var i1 = $AryPoint.length;
	while(i1--){
		// マーカー消去
		$AryPoint[i1].remove($Map);
		// 配列から削除
		$AryPoint.splice(i1, 1);
	}
}
/*---------------
// 範囲円を描画
---------------*/
$AryM2P_Circle = [];

function subA2P_GCircle(
	$selectId,
	$textareaId
){
	// 消去
	for(var _s1 of $AryM2P_Circle){
		_s1.remove();
	}

	// 描画
	var rad = parseInt(document.getElementById($selectId).value, 10);
	if(rad < 1){
		return;
	}

	var i1 = 0;
	for(var _s1 of document.getElementById($textareaId).value.trimEnd().split("\n")){
		_s1 = _s1.trim();

		try{
			var _a1 = _s1.split("\t");
			$AryM2P_Circle[i1] = L.greatCircle(
				[_a1[0], _a1[1]],
				{
					radius: parseInt(document.getElementById($selectId).value, 10),
					color: "#f00",
					fill: true,
					fillColor: "#f00",
					fillOpacity: 0.1
				}
			);
			$AryM2P_Circle[i1].addTo($Map);
			i1++;
		}
		catch(e){
		}
	}
}
/*-------------------
// 度分秒 => 十進法
-------------------*/
function rtnGeoIBLto10A(
	$deg, // 度
	$min, // 分
	$sec  // 秒
){
	$deg = parseInt($deg, 10);
	$min = parseInt($min, 10);
	$sec = parseFloat($sec);
	return parseFloat($deg + ($min / 60.0) + ($sec / 3600.0));
}
/*-------------------
// 十進法 => 度分秒
-------------------*/
function rtnGeo10toIBL(
	$angle // 十進法
){
	$angle = parseFloat($angle);

	var sign = 1;

	if($angle < 0){
		sign = -1;
		$angle = -$angle;
	}
	var deg = parseInt($angle, 10);
		$angle = ($angle - deg) * 60.0;
	var min = parseInt($angle, 10);
		$angle -= min;
	var sec = parseFloat($angle) * 60.0;

	// 0.999... * 60 => 60.0 対策
	if(sec == 60.0){
		min += 1;
		sec = 0;
	}

	return [parseInt(deg, 10) * sign, parseInt(min, 10), parseFloat(sec)];
}
/*-------------------------------
// Vincenty法による２点間の距離
-------------------------------*/
/*【参考】
	http://tancro.e-central.tv/grandmaster/script/vincentyJS.html
*/
function rtnGeoVincentry(
	$lat1,
	$lng1,
	$lat2,
	$lng2
){
	$lat1 = parseFloat($lat1);
	$lng1 = parseFloat($lng1);
	$lat2 = parseFloat($lat2);
	$lng2 = parseFloat($lng2);

	if($lat1 == $lat2 && $lng1 == $lng2){
		return [0, 0];
	}

	/// const _A = 6378137.0;
	const _B   = 6356752.314;
	const _F   = 1 / 298.257222101;
	const _RAD = Math.PI / 180.0;

	const latR1 = $lat1 * _RAD;
	const lngR1 = $lng1 * _RAD;
	const latR2 = $lat2 * _RAD;
	const lngR2 = $lng2 * _RAD;

	const f1 = 1 - _F;

	const omega = lngR2 - lngR1;
	const tanU1 = f1 * Math.tan(latR1);
	const cosU1 = 1 / Math.sqrt(1 + tanU1 * tanU1);
	const sinU1 = tanU1 * cosU1;
	const tanU2 = f1 * Math.tan(latR2);
	const cosU2 = 1 / Math.sqrt(1 + tanU2 * tanU2);
	const sinU2 = tanU2 * cosU2;

	var lamda = omega;
	var dLamda = 0;

	var sinLamda  = 0.0;
	var cosLamda  = 0.0;
	var sin2sigma = 0.0;
	var sinSigma  = 0.0;
	var cosSigma  = 0.0;
	var sigma     = 0.0;
	var sinAlpha  = 0.0;
	var cos2alpha = 0.0;
	var cos2sm    = 0.0;
	var c = 0.0;

	var count = 0;

	do{
		sinLamda = Math.sin(lamda);
		cosLamda = Math.cos(lamda);
		sin2sigma = (cosU2 * sinLamda) * (cosU2 * sinLamda) + (cosU1 * sinU2 - sinU1 * cosU2 * cosLamda) * (cosU1 * sinU2 - sinU1 * cosU2 * cosLamda);
		if(sin2sigma < 0){
			return [0, 0];
		}
		sinSigma = Math.sqrt(sin2sigma);
		cosSigma = sinU1 * sinU2 + cosU1 * cosU2 * cosLamda;
		sigma = Math.atan2(sinSigma, cosSigma);
		sinAlpha = cosU1 * cosU2 * sinLamda / sinSigma;
		cos2alpha = 1 - sinAlpha * sinAlpha;
		cos2sm = cosSigma - 2 * sinU1 * sinU2 / cos2alpha;
		if(isNaN(cos2sm)){
			cos2sm = 0;
		}
		c = _F / 16 * cos2alpha * (4 + _F * (4 - 3 * cos2alpha));
		dLamda = lamda;
		lamda = omega + (1 - c) * _F * sinAlpha * (sigma + c * sinSigma * (cos2sm + c * cosSigma * (-1 + 2 * cos2sm * cos2sm)));
		if(count++ > 10){
			break;
		}
	}while(Math.abs(lamda - dLamda) > 1e-12);

	var u2 = cos2alpha * (1 - f1 * f1) / (f1 * f1);
	var a = 1 + u2 / 16384 * (4096 + u2 * (-768 + u2 * (320 - 175 * u2)));
	var b = u2 / 1024 * (256 + u2 * (-128 + u2 * (74 - 47 * u2)));
	var dSigma = b * sinSigma * (cos2sm + b / 4 * (cosSigma * (-1 + 2 * cos2sm * cos2sm) - b / 6 * cos2sm * (-3 + 4 * sinSigma * sinSigma) * (-3 + 4 * cos2sm * cos2sm)));
	var angle = Math.atan2(cosU2 * sinLamda, cosU1 * sinU2 - sinU1 * cosU2 * cosLamda) * 180 / Math.PI;
	var dist = _B * a * (sigma - dSigma);

	// 変換
	if(angle < 0){
		angle += 360.0; // "度"
	}
	dist /= 1000.0; // "m" => "km"

	return [parseFloat(dist), parseFloat(angle)];
}
/*-----------
// 標高取得
-----------*/
function subGetElevation(
	$lat,
	$lng,
	$oMarker
){
	const _Url = "https://cyberjapandata2.gsi.go.jp/general/dem/scripts/getelevation.php?lat=" + $lat + "&lon=" + $lng + "&outtype=JSON";

	var xhr = new XMLHttpRequest();
	xhr.onload = function(){
		try{
			var json = xhr.response;
			$oMarker.elevation = json.elevation + "m DEM" + json.hsrc;
		}
		catch(e){
			$oMarker.elevation = "---";
		}
	};
	xhr.open("GET", _Url, true);
	xhr.responseType = "json";
	xhr.send(null);
}
/*---------------------------------
// ポップアップ ← ベースマーカー
---------------------------------*/
function subMarkerPopup1(
	$lat,
	$lng
){
	subLatLngToPlaceName($lat, $lng, $BaseMarker, null);

	var [deg, min, sec] = rtnGeo10toIBL($lat);
	var latRem = deg + "度" + min + "分" + parseFloat(sec).toFixed(6) + "秒";

	var [deg, min, sec] = rtnGeo10toIBL($lng);
	var lngRem = deg + "度" + min + "分" + parseFloat(sec).toFixed(6) + "秒";

	subGetElevation($lat, $lng, $BaseMarker);

	return (
		"<font color='#ff5858'>" + $BaseMarker.options.title + "</font><br/>" +
		"<font color='#3d7cce'>北緯</font>" + latRem + "／" + $lat.toFixed(6) + "度<br/>" +
		"<font color='#3d7cce'>東経</font>" + lngRem + "／" + $lng.toFixed(6) + "度<br/>" +
		"<font color='#3d7cce'>標高</font>" + $BaseMarker.elevation
	);
}
/*-----------------------------------
// ポップアップ ← ローカルマーカー
-----------------------------------*/
function subMarkerPopup2(
	$latFrom,
	$lngFrom,
	$latTo,
	$lngTo,
	$oMarker
){
	subLatLngToPlaceName($latTo, $lngTo, $oMarker, null);

	var [deg, min, sec] = rtnGeo10toIBL($latTo);
	var latRem = deg + "度" + min + "分" + parseFloat(sec).toFixed(6) + "秒";

	var [deg, min, sec] = rtnGeo10toIBL($lngTo);
	var lngRem = deg + "度" + min + "分" + parseFloat(sec).toFixed(6) + "秒";

	var [dist, angle] = rtnGeoVincentry($latFrom, $lngFrom, $latTo, $lngTo);
		dist = dist.toFixed(4);
		angle = angle.toFixed(4);

	var distRem = dist + "km";

	var angleRem = "";
	if(angle >= 337.5 || angle <= 22.5){
		angleRem = "北";
	}
	else if(angle > 22.5 && angle < 67.5){
		angleRem = "北東";
	}
	else if(angle >= 67.5 && angle <= 112.5){
		angleRem = "東";
	}
	else if(angle > 112.5 && angle < 157.5){
		angleRem = "南東";
	}
	else if(angle >= 157.5 && angle <= 202.5){
		angleRem = "南";
	}
	else if(angle > 202.5 && angle < 247.5){
		angleRem = "南西";
	}
	else if(angle >= 247.5 && angle <= 292.5){
		angleRem = "西";
	}
	else if(angle > 292.5 && angle < 337.5){
		angleRem = "北西";
	}
	angleRem += angle + "度";

	subGetElevation($latTo, $lngTo, $oMarker);

	return (
		"<font color='#ff5858'>" + $oMarker.options.title + "</font><br/>" +
		"<font color='#3d7cce'>北緯</font>" + latRem + "／" + $latTo.toFixed(6) + "度<br/>" +
		"<font color='#3d7cce'>東経</font>" + lngRem + "／" + $lngTo.toFixed(6) + "度<br/>" +
		"<font color='#3d7cce'>標高</font>" + $oMarker.elevation + "<br/>" +
		"<font color='#3d7cce'>距離</font>" + distRem + "／" + angleRem
	);
}
/*------------------------------------
// [マーカー消去]ボタン 表示／非表示
------------------------------------*/
function subMyObj_Init(){
	document.getElementById("_btnMarker").style.display = "none";
}
function subMyObj_OnOff(
	$aryObj
){
	document.getElementById("_btnMarker").style.display = ($aryObj.length > 0 ? "" : "none");
}
/*-----------------------
// ローカルマーカー消去
-----------------------*/
function subMyObj_Remove(
	$aryObj
){
	var obj = null;
	while((obj = $aryObj.pop()) != undefined){
		obj.remove($Map);
	}
	// [マーカー消去]ボタン 非表示
	document.getElementById("_btnMarker").style.display = "none";
}
/*----------------------
// [Tab]入力可能にする
----------------------*/
/*【参考】
	http://www.webclap-dandy.com/?category=Programing&id=5
*/
function subAddTabCtrl(
	$e,
	$obj
){
	if($e.keyCode != 9){
		return;
	}
	$e.preventDefault();

	var cursorPosition = $obj.selectionStart;
	var cursorLeft  = $obj.value.substr(0, cursorPosition);
	var cursorRight = $obj.value.substr(cursorPosition, $obj.value.length);

	$obj.value = cursorLeft + "\t" + cursorRight;
	$obj.selectionEnd = cursorPosition + 1;
}
/*---------
// 海水面
---------*/
var $Dem10ToSeaLevel = new L.GridLayer();

function subDem10ToSeaLevel($id){
	try{
		$Dem10ToSeaLevel.remove($Map);
		if(document.getElementById($id).value <= 0){
			document.getElementById($id).value = 0;
			return;
		}
	}
	catch(e){
		return;
	}

	var SeaLevel = (parseFloat(document.getElementById($id).value) + 1) * 100; // m => cm

	$Dem10ToSeaLevel.createTile = function(coords){
		var tile = L.DomUtil.create("canvas", "leaflet-tile");
			tile.width = tile.height = 256;
		var ctx = tile.getContext("2d");
		var img = new Image();
			img.crossOrigin = "anonymous";
			// leafletが使うタイルと別のサーバ（https／http）にアクセスし、Access-Control-Allow-Originを回避
			img.src = "https://cyberjapandata.gsi.go.jp/xyz/dem_png/" + coords.z + "/" + coords.x + "/" + coords.y + ".png";
		img.onload = function(){
			ctx.drawImage(this, 0, 0);
			var rtnImg = ctx.getImageData(0, 0, 256, 256);
			var rtnImgData = rtnImg.data;
			// 透過画像を作成
			for(var _i1 = 0, _i2 = rtnImgData.length; _i1 < _i2; _i1+=4){
				elevation = (rtnImgData[_i1 + 0] * 65536) + (rtnImgData[_i1 + 1] * 256) + rtnImgData[_i1 + 2];

				if(elevation < 8388608){
					;
				}
				else if(elevation == 8388608){
					;
				}
				else{
					elevation = (elevation - 16777216);
				}

				if(elevation == 8388608 || elevation < SeaLevel){
					rtnImgData[_i1 + 0] = 100;
					rtnImgData[_i1 + 1] = 0;
					rtnImgData[_i1 + 2] = 200;
					rtnImgData[_i1 + 3] = 180;
				}
				else{
					rtnImgData[_i1 + 3] = 0;
				}
			}
			ctx.putImageData(rtnImg, 0, 0);
		}
		return tile;
	}
	$Dem10ToSeaLevel.addTo($Map);
}
/*---------
// 距離円
---------*/
var $GCircle = null;

// 初期化
function subGCircle_Init(){
	if($GCircle){
		$GCircle.remove();
	}

	$GCircle = L.greatCircle(
		$BaseMarker.getLatLng(),
		{
			radius: subGCircle_Scale(),
			color: "#00f",
			fill: true,
			fillColor: "#00f",
			fillOpacity: 0.1
		}
	);
	$GCircle.addTo($Map);
	$GCircle.bindTo($BaseMarker);
}
// スライダー制御
function subGCircle_Slider(){
	var iDist = subGCircle_Scale();
	document.getElementById("$GCircleKm").innerHTML = (iDist / 1000.0).toFixed(2) + "km";
	$GCircle.setRadius(iDist);
}
// 目盛毎の単位で変換 (例)10 => 10mスケール
function subGCircle_Scale(){
	const scale = 10; // Meter単位
	return parseInt(document.getElementById("_GCircleRange").value, 10) * scale;
}
</script>
</head>

<body onload="subInitDisp();subIwmInput_Init();subMyObj_Init();subAddMatch_Init();subGCircle_Init();subSimpleWindow_Init(['_SW05','_SW04','_SW03','_SW02','_SW01']);" onresize="subInitDisp();">
	<!---------------
	// 数値入力補完
	---------------->
	<div id="_InputZoomA">
		ズームレベル<br>
		<input type="button" class="_ZA" value="5" onclick="_iwmZA('5');"><input type="button" class="_ZA" value="6" onclick="_iwmZA('6');"><input type="button" class="_ZA" value="7" onclick="_iwmZA('7');"><input type="button" class="_ZA" value="8" onclick="_iwmZA('8');"><input type="button" class="_ZA" value="9" onclick="_iwmZA('9');"><br>
		<input type="button" class="_ZA" value="10" onclick="_iwmZA('10');"><input type="button" class="_ZA" value="11" onclick="_iwmZA('11');"><input type="button" class="_ZA" value="12" onclick="_iwmZA('12');"><input type="button" class="_ZA" value="13" onclick="_iwmZA('13');"><input type="button" class="_ZA" value="14" onclick="_iwmZA('14');"><br>
		<input type="button" class="_ZA" value="15" onclick="_iwmZA('15');"><input type="button" class="_ZA" value="16" onclick="_iwmZA('16');"><input type="button" class="_ZA" value="17" onclick="_iwmZA('17');"><input type="button" class="_ZA" value="18" onclick="_iwmZA('18');"><input type="button" class="_ZA" value="19" onclick="_iwmZA('19');"><br>
		<input type="button" class="_ZA" value="20" onclick="_iwmZA('20');"><input type="button" class="_ZA" value="21" onclick="_iwmZA('21');"><input type="button" class="_ZA" value="22" onclick="_iwmZA('22');"><input type="button" class="_ZA" value="23" onclick="_iwmZA('23');"><input type="button" class="_Btn3" value="＋" onclick="_iwmZA2();">
	</div>
	<div id="_InputZoomB">
		<input type="button" class="_ZB" value="23" onclick="_iwmZB('23');"><br>
		<input type="button" class="_ZB" value="22" onclick="_iwmZB('22');"><br>
		<input type="button" class="_ZB" value="21" onclick="_iwmZB('21');"><br>
		<input type="button" class="_ZB" value="20" onclick="_iwmZB('20');"><br>
		<input type="button" class="_ZB" value="19" onclick="_iwmZB('19');"><br>
		<input type="button" class="_ZB" value="18" onclick="_iwmZB('18');"><br>
		<input type="button" class="_ZB" value="17" onclick="_iwmZB('17');"><br>
		<input type="button" class="_ZB" value="16" onclick="_iwmZB('16');"><br>
		<input type="button" class="_ZB" value="15" onclick="_iwmZB('15');"><br>
		<input type="button" class="_ZB" value="14" onclick="_iwmZB('14');"><br>
		<input type="button" class="_ZB" value="13" onclick="_iwmZB('13');"><br>
		<input type="button" class="_ZB" value="12" onclick="_iwmZB('12');"><br>
		<input type="button" class="_ZB" value="11" onclick="_iwmZB('11');"><br>
		<input type="button" class="_ZB" value="10" onclick="_iwmZB('10');"><br>
		<input type="button" class="_ZB" value="9" onclick="_iwmZB('9');"><br>
		<input type="button" class="_ZB" value="8" onclick="_iwmZB('8');"><br>
		<input type="button" class="_ZB" value="7" onclick="_iwmZB('7');"><br>
		<input type="button" class="_ZB" value="6" onclick="_iwmZB('6');"><br>
		<input type="button" class="_ZB" value="5" onclick="_iwmZB('5');">
	</div>
	<div id="_InputBL">
		<input type="text" id="_IBL1" onclick="subIwmInput_BL_GetId(this.id);" onkeydown="subIwmInput_BL_Keydown(this.id, 0);" style="width:37px;">度<input type="text" id="_IBL2" onclick="subIwmInput_BL_GetId(this.id);" onkeydown="subIwmInput_BL_Keydown(this.id, 0);" style="width:37px;">分<br>
		<input type="text" id="_IBL3" onclick="subIwmInput_BL_GetId(this.id);" onkeydown="subIwmInput_BL_Keydown(this.id, 8);" style="width:96px;">秒<br>
		<input type="button" class="_Btn1" value="7" onclick="subIwmInput_AddText('7');"><input type="button" class="_Btn1" value="8" onclick="subIwmInput_AddText('8');"><input type="button" class="_Btn1" value="9" onclick="subIwmInput_AddText('9');"><br>
		<input type="button" class="_Btn1" value="4" onclick="subIwmInput_AddText('4');"><input type="button" class="_Btn1" value="5" onclick="subIwmInput_AddText('5');"><input type="button" class="_Btn1" value="6" onclick="subIwmInput_AddText('6');"><br>
		<input type="button" class="_Btn1" value="1" onclick="subIwmInput_AddText('1');"><input type="button" class="_Btn1" value="2" onclick="subIwmInput_AddText('2');"><input type="button" class="_Btn1" value="3" onclick="subIwmInput_AddText('3');"><br>
		<input type="button" class="_Btn1" value="0" onclick="subIwmInput_AddText('0');"><input type="button" class="_Btn1" value="." onclick="subIwmInput_AddText('.');"><input type="button" class="_Btn2" value="Cls" onclick="subIwmInput_Cls();"><br>
		<input type="button" class="_Btn2" value="BS" onclick="subIwmInput_Bs();"><input type="button" class="_Btn2" value="Del" onclick="subIwmInput_Del();"><input type="button" class="_Btn3" value="OK" onclick="_iwmBL();">
	</div>
	<!---------------------
	// アドレスマッチング
	---------------------->
	<div id="_AddMatchInput">
		<input type="text" id="_AddMatchInput1" onchange="subAddMatch_1();" placeholder="住所検索"><font id="_AddMatchInput2" onclick="subAddMatch_2();"></font><font id="_AddMatchInput3" onclick="subAddMatch_Init();">×</font>
	</div>
	<div id="_AddMatchOutput"></div>
	<!-------------------
	// 地理院地図の設定
	-------------------->
	<div id="_divNaviCommander">
		北緯：<input type="text" id="_NaviLat" onclick="subIwmInput_BL_Open(this.id);" onkeydown="subIwmInput_BL_Keydown(this.id, 8);" placeholder="緯度入力"/>
		東経：<input type="text" id="_NaviLng" onclick="subIwmInput_BL_Open(this.id);" onkeydown="subIwmInput_BL_Keydown(this.id, 8);" placeholder="経度入力"/>
		<!-- ズーム --><input type="hidden" id="_NaviZoom"/>
		<input type="button" class="_btnNavi1" value="＋" onclick="_iwmZA2();"/>
		<input type="button" id="_btnMarker" class="_btnNavi2" value="マーカー消去" onclick="subMyObj_Remove($AryLocalMarker);"/>
		<!---------
		// ヘルプ
		---------->
		<span style="float:right;margin:0 8px 0 4px;">
			<font class="_simpleWindowCall" onclick="subSimpleWindow_OnOff('_SW01','subSimpleWindow_HDoc01(\'_SW01A\')');" style="font-weight:900;">？</font>
		</span>
		<div id="_SW01" class="_simpleWindow" style="width:320px;">
			<font class="_simpleWindowTitle">操作説明</font>
			<font class="_simpleWindowClose" onclick="subSimpleWindow_OnOff('_SW01');">×</font>
			<div id="_SW01A" class="_simpleWindowOutput" style="max-height:480px;"></div>
		</div>
		<!-----------------
		// 追加タイル編集
		------------------>
		<span style="float:right;margin:0 4px;">
			<font class="_simpleWindowCall" onclick="subSimpleWindow_OnOff('_SW02');" style="font-weight:500;">追加タイル編集</font>
		</span>
		<div id="_SW02" class="_simpleWindow" style="width:400px;">
			<font class="_simpleWindowTitle">追加タイル編集／[Tab]区切り</font>
			<font class="_simpleWindowClose" onclick="subSimpleWindow_OnOff('_SW02');">×</font>
			<br>
			<textarea id="_TA01" class="_editTextBox" wrap="off" style="height:180px;width:380px;" onchange="subMapSelector();"></textarea>
			<script>
				document.getElementById("_TA01").onkeydown = function(e){subAddTabCtrl(e, this);}
			</script>
			<div style="margin:10px 0;">
				<a class="_btnNavi3" href="http://maps.gsi.go.jp/development/ichiran.html" target="_blank" style="font-size:14px;">地理院タイル一覧⇒</a>
			</div>
		</div>
		<!---------------
		// マーカー変換
		---------------->
		<span style="float:right;margin:0 4px;">
			<font class="_simpleWindowCall" onclick="subSimpleWindow_OnOff('_SW03');">マーカー変換</font>
		</span>
		<div id="_SW03" class="_simpleWindow" style="width:480px;">
			<font class="_simpleWindowTitle">マーカーをポイントに変換／[Tab]区切り／UTF-8N）</font>
			<font class="_simpleWindowClose" onclick="subSimpleWindow_OnOff('_SW03');">×</font>
			<div class="_simpleWindowOutput" style="background:#fafafa;min-height:300px;padding:8px;">
				<input type="button" class="_btnNavi3" value=">>地図から読込" onclick="subMapToPoint('_TA02');"/>
				<input type="file" id="_readFn" class="_btnNavi2" onchange="subAddReadFile(this.id,'_TA02');"/>
				<br>
				<textarea id="_TA02" class="_editTextBox" wrap="off" style="height:240px;width:440px;"></textarea>
				<script>
					document.getElementById("_TA02").onkeydown = function(e){subAddTabCtrl(e, this);}
				</script>
				<br>
				<input type="button" class="_btnNavi4" style="margin:3px 0 0 0;" value=">>住所から変換" onclick="subA2P_Geocoding('_TA02');">
				<input type="button" class="_btnNavi4" style="margin:3px 0 0 0;" value="↑サンプル出力" onclick="subA2P_GeocodingSample('_TA02');">
				<input type="button" class="_btnNavi1" value="クリップボードにコピー" onclick="subA2P_EditCopy('_TA02');"/>
				<br>
				<input type="button" class="_btnNavi3" value="<<地図へ反映" onclick="subA2P_PointToMap('_TA02');"/>
				<a id="_btnDL" class="_btnNavi2" href="#" download="" onclick="subA2P_EditSave('_TA02',this.id)">ファイルに保存</a>
				<input type="button" class="_btnNavi1" value="クリア" style="margin:3px 0 0 0;" onclick="subA2P_EditClear('_TA02','_GCircleM2P');"/>
				<select id="_GCircleM2P" style="border:1px solid #505050;" onclick="subA2P_GCircle('_GCircleM2P','_TA02')"><option value="0">範囲円なし</option><option value="50">50m</option><option value="100">100m</option><option value="250">250m</option><option value="500">500m</option><option value="1000">1km</option><option value="2000">2km</option><option value="4000">4km</option><option value="8000">8km</option><option value="20000">20km</option><option value="25000">25km</option><option value="40000">40km</option><option value="100000">100km</option><option value="500000">500km</option><option value="1000000">1000km</option><option value="2000000">2000km</option><option value="5000000">5000km</option></select>
			</div>
		</div>
		<!---------
		// 海水面
		---------->
		<span style="float:right;margin:0 4px;">
			<font id="_AAA" class="_simpleWindowCall" onclick="subSimpleWindow_OnOff('_SW04');" style="font-weight:500;">海水面</font>
		</span>
		<div id="_SW04" class="_simpleWindow" style="right:113px;min-height:45px;width:185px;z-index:900;">
			<font class="_simpleWindowTitle">ズーム14以下で利用可能</font>
			<font class="_simpleWindowClose" onclick="subSimpleWindow_OnOff('_SW04');">×</font>
			<br>
			<input type="number" id="_Dem10ToSeaLevel" value="0" style="text-align:right;width:60px;" onclick="subDem10ToSeaLevel(this.id);" onkeyup="subDem10ToSeaLevel(this.id);"/>ｍ
			<input type="button" class="_btnNavi1" value="ON" onclick="subDem10ToSeaLevel('_Dem10ToSeaLevel');"/>
			<input type="button" class="_btnNavi2" value="OFF" onclick="$Dem10ToSeaLevel.remove($Map);"/>
		</div>
		<!---------
		// 距離円
		---------->
		<span style="float:right;margin:0 4px;">
			<font class="_simpleWindowCall" onclick="subSimpleWindow_OnOff('_SW05');" style="font-weight:500;">距離円</font>
		</span>
		<div id="_SW05" class="_simpleWindow" style="right:304px;min-height:45px;width:228px;z-index:900;">
			<font class="_simpleWindowTitle">半径を指定</font>
			<font class="_simpleWindowClose" onclick="subSimpleWindow_OnOff('_SW05');">×</font>
			<br>
			<div id="_GCircle"><input type="range" id="_GCircleRange" min="0" max="2000" value="0" oninput="subGCircle_Slider();"><span id="$GCircleKm">0km</span></div>
		</div>
	</div>
	<div id="_divMap">
		<script>
		// 地図描写調整
		subInitDisp();

		// URLからXYZ値を取得
		var hash = window.location.hash;

		if(hash.length){
			var aHash = hash.split("/");
			with(document){
				getElementById("_NaviZoom").value = aHash[0].substr(1); // 先頭の'#'より後
				getElementById("_NaviLat").value  = parseFloat(aHash[1]).toFixed(8);
				getElementById("_NaviLng").value  = parseFloat(aHash[2]).toFixed(8);
			}
		}
		else{
			// 初回ズーム
			with(document){
				getElementById("_NaviZoom").value = 5;
			}

			// 初回座標＠皇居
			with(document){
				getElementById("_NaviLat").value = (35.68518697509636).toFixed(8);
				getElementById("_NaviLng").value = (139.7522735595703).toFixed(8);
			}

			// 現在座標取得
			navigator.geolocation.getCurrentPosition(
				function(position){
					with(document){
						getElementById("_NaviLat").value = position.coords.latitude.toFixed(8);
						getElementById("_NaviLng").value = position.coords.longitude.toFixed(8);
						_iwmBMN();
						_iwmCU();
						_iwmCM();
						subGCircle_Init();
					}
				},
				function(error){
					with(document){
						_iwmBMN();
						_iwmCU();
						_iwmCM();
						subGCircle_Init();
					}
				}
			);
		}

		// 【おまじない】複数のポップアップを許可（1.x対応）
		L.Map = L.Map.include(
			{
				openPopup: function(popup, latlng, options){
					if(latlng){
						popup.setLatLng(latlng);
					}
					if(this._popup && this._popup.options.autoClose){
						/// this.closePopup();
					}
					this._popup = popup;
					return this.addLayer(popup);
				}
			}
		);

		// 初回表示設定
		var $Map = L.map(
			"_divMap",
			{
				center: [document.getElementById("_NaviLat").value, document.getElementById("_NaviLng").value],
				zoom: document.getElementById("_NaviZoom").value,
				minZoom: 3,  // 最小ズーム
				maxZoom: 23, // 最大ズーム
				zoomControl: false, // Control.Zoom 非表示
				doubleClickZoom: false // DblClick制御
			}
		);

		/*---------------
		// スケール表示
		---------------*/
		L.control.scale({
			metric: true,
			imperial: false,
			position: "bottomleft"
		}).addTo($Map);

		/*-----------
		// 距離測定
		-----------*/
		L.control.polylineMeasure({
			position: "bottomleft",
			unit: "metres",
			showBearings: false,
			clearMeasurementsOnStop: false,
			showClearControl: true,
			showUnitControl: false
		}).addTo($Map);

		/*--------------------------------------------------------------------------------------
		// メニュー等で使用
		//   [0]'地図種', [1]'URL', [2]'拡張子', [3]'opacity', [4]'maxNativeZoom'
		//   (例) ["std", "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png", 1.0, 18]
		// http://maps.gsi.go.jp/development/ichiran.html
		--------------------------------------------------------------------------------------*/
		var $URL = "https://cyberjapandata.gsi.go.jp/xyz/";

		/*---------------
		// ラジオボタン
		---------------*/
		var $radioButtonSelectMap = [];

		var $radioButtonMap = [];
			$radioButtonMap.push(["標準地図", $URL + "std/{z}/{x}/{y}.png",   1.0, 18, "地理院タイル std"]);
			$radioButtonMap.push(["淡色地図", $URL + "pale/{z}/{x}/{y}.png",  1.0, 18, "地理院タイル pale"]);
			$radioButtonMap.push(["白地図"  , $URL + "blank/{z}/{x}/{y}.png", 1.0, 14, "地理院タイル blank"]);
			$radioButtonMap.push(["なし", "", 0.0, 18]);

		for(var _a1 of $radioButtonMap){
			$radioButtonSelectMap[_a1[0]] = L.tileLayer(
				_a1[1],
				{
					attribution: _a1[4],
					opacity: _a1[2],
					maxNativeZoom: _a1[3],
					maxZoom: 23
				}
			);
		}
		// 初期選択値
		$radioButtonSelectMap[$radioButtonMap[0][0]].addTo($Map);

		/*-----------------------
		// チェックボックス可変
		-----------------------*/
		var $LMapSelector = null;

		function subMapSelector(){
			var $checkBoxSelectMap = [];
			var obj = document.getElementById("_TA01");

			if(obj.value.length == 0){
				obj.value = "// タイル種\t拡張子\t透過率(0.n-1.0)\t最大ズーム\n// [Tab]区切り\nseamlessphoto\tjpg\t1.0\t18\nslopezone1map\tpng\t0.8\t15\n";
			}

			var ary = [];

			for(var _s1 of document.getElementById("_TA01").value.trimEnd().split("\n")){
				_s1 = _s1.trim();

				if(_s1.length > 0 && _s1.substr(0, 2) != "//"){
					var _a1 = _s1.split("\t");

					_a1[0] = _a1[0].trim();

					try{
						_a1[1] = _a1[1].trim();
						if(!_a1[1].length){
							throw null;
						}
					}
					catch(e){
						_a1[1] = "png";
					}

					try{
						_a1[2] = parseFloat(_a1[2]);
						if(isNaN(_a1[2])){
							throw null;
						}
					}
					catch(e){
						_a1[2] = 0.5;
					}

					try{
						_a1[3] = parseInt(_a1[3]);
						if(isNaN(_a1[3])){
							throw null;
						}
					}
					catch(e){
						_a1[3] = 18;
					}

					ary.push([_a1[0], $URL + _a1[0] + "/{z}/{x}/{y}." + _a1[1], _a1[2], _a1[3], ""]);
				}
			}
			ary.push(["シームレス地質図", "https://gbank.gsj.jp/seamless/v2/api/1.2/tiles/{z}/{y}/{x}.png", 0.5, 13, "20万分の1日本シームレス地質図V2@<a href='https://gbank.gsj.jp/seamless/v2.html' target='_blank'>産総研地質調査総合センターウェブサイト</a>"]);
			ary.push(["UTMグリッド", "http://{s}.tile.stamen.com/utm/{z}/{x}/{y}.png", 1.0, 23, "Map tiles by <a href='http://stamen.com' target='_blank'>Stamen Design</a>, under <a href='http://creativecommons.org/licenses/by/3.0' target='_blank'>CC BY 3.0</a>."]);

			for(var _a1 of ary){
				$checkBoxSelectMap[_a1[0]] = L.tileLayer(
					_a1[1],
					{
						attribution: _a1[4],
						opacity: _a1[2],
						maxNativeZoom: _a1[3],
						maxZoom: 23
					}
				);
			}

			/*-----------------
			// 経緯度グリッド
			-----------------*/
			$checkBoxSelectMap["経緯度グリッド"] = L.latlngGraticule(
				{
					color: "#003",
					font: "14px sans-serif",
					latLineCurved: 0,
					lngLineCurved: 0,
					opacity: 1.0,
					showLabel: true,
					weight: 0.6,
					zoomInterval: [
						{
							start: 0,
							end: 5,
							interval: 5
						},
						{
							start: 6,
							end: 23,
							interval: 1
						}
					]
				}
			);

			/*-------------------------
			// ベクトルタイル提供実験
			-------------------------*/
/*
			// 0.7x 対応（1.x 未対応）
			var xhr = new XMLHttpRequest();
			xhr.open(
				"GET",
				"https://cyberjapandata.gsi.go.jp/xyz/experimental_fgd/style.js",
				false
			);
			/// xhr.overrideMimeType("text/javascript");
			xhr.send(null);
			var stylejs = eval( "(" + xhr.responseText + ")" );
			var $FgdLayer = new L.TileLayer.GeoJSON(
				"https://cyberjapandata.gsi.go.jp/xyz/experimental_fgd/{z}/{x}/{y}.geojson",
				stylejs.options,
				stylejs.geojsonOptions
			);
*/

			/*------------------------
			// 標準地図等を色調変換
			------------------------*/
			/*【参考】
				http://sterfield.co.jp/designer/canvas%E3%81%A7%E7%94%BB%E5%83%8F%E3%81%AE%E7%99%BD%E3%82%92%E9%80%8F%E9%81%8E%E3%81%AB%E3%81%99%E3%82%8B/
			*/
			// 標準 => 明色
			var $StdToBright = new L.GridLayer();
			$StdToBright.createTile = function(coords){
				var tile = L.DomUtil.create("canvas", "leaflet-tile");
					tile.width = tile.height = 256;
				var ctx = tile.getContext("2d");
				var img = new Image();
					img.crossOrigin = "anonymous";
					// leafletが使うタイルと別のサーバ（https／http）にアクセスし、Access-Control-Allow-Originを回避
					img.src = "https://cyberjapandata.gsi.go.jp/xyz/std/" + coords.z + "/" + coords.x + "/" + coords.y + ".png";
				img.onload = function(){
					ctx.drawImage(this, 0, 0);
					var rtnImg = ctx.getImageData(0, 0, 256, 256);
					var rtnImgData = rtnImg.data;
					// 透過画像を作成
					for(var _i1 = 0, _i2 = rtnImgData.length; _i1 < _i2; _i1+=4){
						if(rtnImgData[_i1 + 0] > 160 && rtnImgData[_i1 + 1] > 160 && rtnImgData[_i1 + 2] > 160){
							rtnImgData[_i1 + 3] = 0;
						}
						else{
							rtnImgData[_i1 + 3] = 255;
						}
					}
					ctx.putImageData(rtnImg, 0, 0);
				}
				return tile;
			}

			// 標準 => 褐色
			var $StdToBrown = new L.GridLayer();
			$StdToBrown.createTile = function(coords){
				var tile = L.DomUtil.create("canvas", "leaflet-tile");
					tile.width = tile.height = 256;
				var ctx = tile.getContext("2d");
				var img = new Image();
					img.crossOrigin = "anonymous";
					// leafletが使うタイルと別のサーバ（https／http）にアクセスし、Access-Control-Allow-Originを回避
					img.src = "https://cyberjapandata.gsi.go.jp/xyz/std/" + coords.z + "/" + coords.x + "/" + coords.y + ".png";
				img.onload = function(){
					ctx.drawImage(this, 0, 0);
					var rtnImg = ctx.getImageData(0, 0, 256, 256);
					var rtnImgData = rtnImg.data;
					// 透過画像を作成
					for(var _i1 = 0, _i2 = rtnImgData.length; _i1 < _i2; _i1+=4){
						// 各カラーチャンネルで、一番暗い値を取得
						var minLuminance = rtnImgData[_i1];
						if(minLuminance > rtnImgData[_i1 + 1]){
							minLuminance = rtnImgData[_i1 + 1];
						}
						if(minLuminance > rtnImgData[_i1 + 2]){
							minLuminance = rtnImgData[_i1 + 2];
						}
						// 減色
						rtnImgData[_i1 + 0] -= minLuminance;
						rtnImgData[_i1 + 1] -= minLuminance;
						rtnImgData[_i1 + 2] -= minLuminance;
						// 一番暗い値をアルファチャンネルに反映(明るいところほど透明に)
						rtnImgData[_i1 + 3] = 255 - minLuminance;
					}
					ctx.putImageData(rtnImg, 0, 0);
				}
				return tile;
			}

			/*-------------
			// タイル座標
			-------------*/
			var $TileCoord = new L.GridLayer();
			$TileCoord.createTile = function(coords){
				var tile = L.DomUtil.create("canvas", "leaflet-tile");
					tile.width = tile.height = 256;
				var tileText = coords.z + "-" + coords.x + "-" + coords.y;
				var ctx = tile.getContext("2d");
					// 枠線
					ctx.lineWidth = 1;
					ctx.strokeStyle = "#000";
					ctx.strokeRect(0, 0, 255, 255);
					// 文字
					ctx.font = "24px Arial";
					ctx.textAlign = "center";
					ctx.lineWidth = 6.0;
					ctx.strokeStyle = "#fff";
					ctx.strokeText(tileText, 128, 128);
					// 文字ヌキ
					ctx.fillStyle = "#88f";
					ctx.fillText(tileText, 128, 128);
				return tile;
			};

			/// $checkBoxSelectMap["ベクトルタイル提供実験 [z18]"] = $FgdLayer;
			$checkBoxSelectMap["注記／明色 [-z18]"] = $StdToBright;
			$checkBoxSelectMap["注記／褐色 [-z18]"] = $StdToBrown;
			$checkBoxSelectMap["海水面 [-z14]"] = $Dem10ToSeaLevel;
			$checkBoxSelectMap["タイル座標"] = $TileCoord;

			/*-------------------
			// 地図選択メニュー
			-------------------*/
			if($LMapSelector){
				$Map.removeControl($LMapSelector); // 前出を削除
			}
			$LMapSelector = L.control.layers(
				$radioButtonSelectMap,
				$checkBoxSelectMap,
				{
					position: "topright"
				}
			);
			$LMapSelector.addTo($Map);

			// 初回表示の処理
			$Map.on(
				"overlayremove",
				function(e){
					// 地図選択メニューから削除
					$checkBoxSelectMap[e.name].remove($Map);
				}
			);
		}
		subMapSelector();

		// 座標マーカー
		var $BaseMarkerIcon = L.AwesomeMarkers.icon(
			{
				icon: "home",
				prefix: "fa",
				markerColor: "darkblue",
				spin: false
			}
		);
		var $LocalMarkerDragOn = L.AwesomeMarkers.icon(
			{
				icon: "flag",
				prefix: "fa",
				markerColor: "darkred",
				spin: false
			}
		);
		var $LocalMarkerDragOff = L.AwesomeMarkers.icon(
			{
				icon: "thumb-tack",
				prefix: "fa",
				markerColor: "orange",
				spin: false
			}
		);
		/*---------------
		// センタリング
		---------------*/
		function subCenterMap1(
			$Lat,
			$Lng
		){
			$Map.setView(
				[$Lat, $Lng],
				document.getElementById("_NaviZoom").value
			);
		}
		/*-----------------------------
		// マーカーのポップアップ更新
		-----------------------------*/
		function subMarkerPopup(
			$BaseMarker,
			$AryLocalMarker
		){
			// ベースマーカー
			$BaseMarker.closePopup();

			subLatLngToPlaceName(
				$BaseMarker._latlng.lat,
				$BaseMarker._latlng.lng,
				$BaseMarker,
				null
			);

			$BaseMarker.bindPopup(
				subMarkerPopup1(
					$BaseMarker._latlng.lat,
					$BaseMarker._latlng.lng
				),
				{
					autoPan: false // ポップアップ時、表示調整しない
				}
			);
			$BaseMarker.openPopup();

			// ローカルマーカー
			for(var _s1 of $AryLocalMarker){
				_s1.closePopup();
				_s1.bindPopup(
					subMarkerPopup2(
						$BaseMarker._latlng.lat,
						$BaseMarker._latlng.lng,
						_s1._latlng.lat,
						_s1._latlng.lng,
						_s1
					),
					{
						autoPan: false // ポップアップ時、表示調整しない
					}
				);
				_s1.openPopup();
			}
		}
		/*---------------------
		// ベースマーカー描画
		---------------------*/
		var $BaseMarker = null;
		var $AryLocalMarker = [];

		function subBaseMarkerNew(
			$Lat,
			$Lng
		){
			for(var _i1 = 0, _i2 = arguments.length; _i1 < _i2; _i1++){
				if(isNaN(arguments[_i1])){
					arguments[_i1] = document.getElementById(arguments[_i1]).value;
				}
			}
			if($BaseMarker){
				$BaseMarker.remove($Map);
			}
			$BaseMarker = L.marker(
				[$Lat, $Lng],
				{
					icon: $BaseMarkerIcon,
					draggable: true // ドラッグ許可
				}
			).addTo($Map);

			$BaseMarker.elevation = "---";

			// URL／BL表示を変更
			subChangeUrl($Lat, $Lng, "_NaviZoom");

			// ズームレベル変更 <= click
			$BaseMarker.on(
				"click",
				function(e){
					// ズームレベル補完
					var mouseP = $Map.latLngToContainerPoint(this.getLatLng());
					subIwmInput_ZoomA_Open(
						"_NaviZoom",
						(mouseP.x + 30),
						(mouseP.y - 40)
					);
				}
			);
			// 全ポップアップ表示 <= contextmenu
			$BaseMarker.on(
				"contextmenu",
				function(e){
					this.closePopup();
					subMarkerPopup($BaseMarker, $AryLocalMarker);
					var i1 = $AryPoint.length;
					while(i1--){
						$AryPoint[i1].openPopup();
					}
				}
			);
			// ポップアップ情報更新 <= dragend
			$BaseMarker.on(
				"dragend",
				function(e){
					// URL／BL表示を変更
					var a1 = this.getLatLng();

					subChangeUrl(a1.lat, a1.lng, "_NaviZoom");

					// "_InputBL" を更新
					_iwmIBL($subIwmInput_BL_toSave);

					// 表示を更新して、すぐに隠す
					subMarkerPopup($BaseMarker, $AryLocalMarker);

					this.closePopup();
				}
			);
			// 何もしない <= mouseover
			$BaseMarker.on(
				"mouseover",
				function(e){
					// 先読みしておく
					subMarkerPopup1($BaseMarker._latlng.lat, $BaseMarker._latlng.lng);
				}
			);
			// ポップアップ非表示 <= mouseout
			$BaseMarker.on(
				"mouseout",
				function(e){
					/// $BaseMarker.closePopup();
					/*
						for(var _s1 of $AryLocalMarker){
							_s1.closePopup();
						}
					*/
				}
			);
		}

		// ベースマーカー初回描画
		_iwmBMN();

		// ズームバー
		subIwmInput_Zoom_Change($Map.getZoom());

		// ミニマップ
		var miniMapLayer = new L.TileLayer(
			"https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
			{
				minZoom: 3,
				maxZoom: 18
			}
		);
		new L.Control.MiniMap(
			miniMapLayer,
			{
				toggleDisplay: true
			}
		).addTo($Map);

		/*-----------------
		// 右クリック共通
		-----------------*/
		function subMapOnRClick(
			$lat,
			$lng,
			$placeName
		){
			var bIconDrag = false;
			if(!$placeName){
				bIconDrag = true;
			}

			// マーカー作成
			$AryLocalMarker.push(
				L.marker(
					[$lat, $lng],
					{
						icon: (bIconDrag ? $LocalMarkerDragOn : $LocalMarkerDragOff),
						draggable: bIconDrag
					}
				).addTo($Map)
			);

			$AryLocalMarker[$AryLocalMarker.length - 1].elevation = "---";

			// [マーカー消去]ボタン表示
			subMyObj_OnOff($AryLocalMarker);

			// 現在(配列)のローカルマーカー
			var obj = $AryLocalMarker[$AryLocalMarker.length - 1];

			// 緯度経度から地名を検索
			subLatLngToPlaceName(
				$lat,
				$lng,
				obj,
				(bIconDrag ? null : ("★" + $placeName))
			);

			// 固定点地名のときだけセンタリング
			if(!bIconDrag){
				subCenterMap1($lat, $lng);
			}

			// ズームレベル補完 <= click
			obj.on(
				"click",
				function(e){
					// ズームレベル補完
					_iwmCM_hash = this.getLatLng();
					var mouseP = $Map.latLngToContainerPoint(_iwmCM_hash);
					subIwmInput_ZoomA_Open(
						"_NaviZoom",
						(mouseP.x + 20),
						(mouseP.y - 25)
					);
				}
			);
			// マーカー消去 <= contextmenu
			obj.on(
				"contextmenu",
				function(e){
					var i1 = $AryLocalMarker.length;
					while(i1--){
						if(this == $AryLocalMarker[i1]){
							// マーカー消去
							$AryLocalMarker[i1].remove($Map);
							// 配列から削除
							$AryLocalMarker.splice(i1, 1);
							break;
						}
					}
					// [マーカー消去]ボタン非表示
					subMyObj_OnOff($AryLocalMarker);
				}
			);
			// ドラッグ <= dragend
			obj.on(
				"dragend",
				function(e){
					// 先読みしておく
					subMarkerPopup2(
						$BaseMarker._latlng.lat,
						$BaseMarker._latlng.lng,
						this._latlng.lat,
						this._latlng.lng,
						this
					);
				}
			);
			// ポップアップ表示更新 <= mouseover
			obj.on(
				"mouseover",
				function(e){
					// 先読みしておく
					subMarkerPopup2(
						$BaseMarker._latlng.lat,
						$BaseMarker._latlng.lng,
						this._latlng.lat,
						this._latlng.lng,
						this
					);
				}
			);
			// ポップアップ再表示 <= mouseout
			obj.on(
				"mouseout",
				function(e){
					this.closePopup();
					this.bindPopup(
						subMarkerPopup2(
							$BaseMarker._latlng.lat,
							$BaseMarker._latlng.lng,
							this._latlng.lat,
							this._latlng.lng,
							this
						),
						{
							autoPan: false // ポップアップ時、表示調整しない
						}
					);
					this.openPopup();
				}
			);
		}

		/*---------------------
		// 地図上イベント共通
		---------------------*/
		// マーカー毎のイベント設定後でないと不具合
		$Map.on(
			"dblclick",
			function(e){
				// ズームレベル補完
				subIwmInput_ZoomA_Open(
					"_NaviZoom",
					(e.containerPoint.x + 20),
					(e.containerPoint.y - 25)
				);
				// ベースマーカー再描画
				subBaseMarkerNew(e.latlng.lat, e.latlng.lng);
				// 距離円再描画
				subGCircle_Init();
			}
		);
		$Map.on(
			"contextmenu",
			function(e){
				subMapOnRClick(e.latlng.lat, e.latlng.lng, null);
			}
		);
		$Map.on(
			"zoomend",
			function(e){
				// URL／BL表示を変更
				subChangeUrl("_NaviLat", "_NaviLng", $Map.getZoom());
				// ズームバー
				subIwmInput_Zoom_Change($Map.getZoom());
			}
		);
		</script>
	</div>
</body>

</html>

<!---------------------
// ヒアドキュメント風
---------------------->
<textarea id="_HDoc01" style="display:none;">
<style>
._fs1{color:#f00;}
._fs2{color:#00f;}
._ol, ._ul{margin:0;padding:0;}
._li1, ._li2{padding:1px;}
._li1{margin:0 0 0 32px;}
._li2{margin:0 0 0 0;}
._ol ._li1{padding:6px 0 0 0;}
</style>
<span class="_fs1">【地図上でのマウス操作】</span>
 <ul class="_ul">
  <li class="_li1">ダブルクリック：青マーカー移動</li>
  <li class="_li1">左クリック：全ポップアップ非表示</li>
  <li class="_li1">右クリック：赤マーカー追加</li>
 </ul>
<br>
<span class="_fs2">【マーカー上でのマウス操作】</span>
 <ol class="_ol">
  <li class="_li1">青マーカー
   <ul class="_ul">
    <li class="_li2">左クリック：ズームレベル</li>
    <li class="_li2">右クリック：全ポップアップ</li>
    <li class="_li2">ドラッグ：移動</li>
    <li class="_li2">マウスオーバー：何もしない</li>
   </ul>
  </li>
  <li class="_li1">赤マーカー
   <ul class="_ul">
    <li class="_li2">左クリック：ズームレベル</li>
    <li class="_li2">右クリック：消去</li>
    <li class="_li2">ドラッグ：移動</li>
    <li class="_li2">マウスオーバー：ポップアップ</li>
   </ul>
  </li>
  <li class="_li1">オレンジマーカー
   <ul class="_ul">
    <li class="_li2">左クリック：ズームレベル</li>
    <li class="_li2">右クリック：消去</li>
    <li class="_li2">ドラッグ：何もしない</li>
    <li class="_li2">マウスオーバー：ポップアップ</li>
   </ul>
  </li>
 </ol>
</li>
</textarea>
